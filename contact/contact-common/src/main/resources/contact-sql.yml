# Copyright (c) 2026 Bob Hablutzel. All rights reserved.
#
# Licensed under a dual-license model: freely available for non-commercial use;
# commercial use requires a separate license. See LICENSE file for details.
# Contact license@geastalt.com for commercial licensing.

contact:
  sql:
    search:
      by-name-exact: >-
        SELECT m.id, m.first_name, m.last_name,
        me.email as preferred_email,
        al1.line_value as address_line_1, al2.line_value as address_line_2,
        sa.locality, sa.administrative_area, sa.postal_code, sa.country_code
        FROM contacts m
        LEFT JOIN contact_emails me ON me.contact_id = m.id AND me.preferred = true
        LEFT JOIN contact_addresses ma ON ma.contact_id = m.id AND ma.preferred = true
        LEFT JOIN addresses sa ON sa.id = ma.address_id
        LEFT JOIN address_lines al1 ON al1.address_id = sa.id AND al1.line_order = 1
        LEFT JOIN address_lines al2 ON al2.address_id = sa.id AND al2.line_order = 2
        WHERE m.last_name_lower = :lastName
        LIMIT :limit

      by-name-exact-with-first-name: >-
        SELECT m.id, m.first_name, m.last_name,
        me.email as preferred_email,
        al1.line_value as address_line_1, al2.line_value as address_line_2,
        sa.locality, sa.administrative_area, sa.postal_code, sa.country_code
        FROM contacts m
        LEFT JOIN contact_emails me ON me.contact_id = m.id AND me.preferred = true
        LEFT JOIN contact_addresses ma ON ma.contact_id = m.id AND ma.preferred = true
        LEFT JOIN addresses sa ON sa.id = ma.address_id
        LEFT JOIN address_lines al1 ON al1.address_id = sa.id AND al1.line_order = 1
        LEFT JOIN address_lines al2 ON al2.address_id = sa.id AND al2.line_order = 2
        WHERE m.last_name_lower = :lastName AND m.first_name_lower = :firstName
        LIMIT :limit

      by-name-prefix: >-
        SELECT m.id, m.first_name, m.last_name,
        me.email as preferred_email,
        al1.line_value as address_line_1, al2.line_value as address_line_2,
        sa.locality, sa.administrative_area, sa.postal_code, sa.country_code
        FROM contacts m
        LEFT JOIN contact_emails me ON me.contact_id = m.id AND me.preferred = true
        LEFT JOIN contact_addresses ma ON ma.contact_id = m.id AND ma.preferred = true
        LEFT JOIN addresses sa ON sa.id = ma.address_id
        LEFT JOIN address_lines al1 ON al1.address_id = sa.id AND al1.line_order = 1
        LEFT JOIN address_lines al2 ON al2.address_id = sa.id AND al2.line_order = 2
        WHERE m.last_name_lower LIKE :lastNamePattern
        LIMIT :limit

      by-name-prefix-with-first-name: >-
        SELECT m.id, m.first_name, m.last_name,
        me.email as preferred_email,
        al1.line_value as address_line_1, al2.line_value as address_line_2,
        sa.locality, sa.administrative_area, sa.postal_code, sa.country_code
        FROM contacts m
        LEFT JOIN contact_emails me ON me.contact_id = m.id AND me.preferred = true
        LEFT JOIN contact_addresses ma ON ma.contact_id = m.id AND ma.preferred = true
        LEFT JOIN addresses sa ON sa.id = ma.address_id
        LEFT JOIN address_lines al1 ON al1.address_id = sa.id AND al1.line_order = 1
        LEFT JOIN address_lines al2 ON al2.address_id = sa.id AND al2.line_order = 2
        WHERE m.last_name_lower LIKE :lastNamePattern AND m.first_name_lower LIKE :firstNamePattern
        LIMIT :limit

      count-by-name-exact: >-
        SELECT COUNT(*) FROM contacts WHERE last_name_lower = :lastName

      count-by-name-exact-with-first-name: >-
        SELECT COUNT(*) FROM contacts WHERE last_name_lower = :lastName AND first_name_lower = :firstName

      count-by-name-prefix: >-
        SELECT COUNT(*) FROM contacts WHERE last_name_lower LIKE :lastNamePattern

      count-by-name-prefix-with-first-name: >-
        SELECT COUNT(*) FROM contacts WHERE last_name_lower LIKE :lastNamePattern AND first_name_lower LIKE :firstNamePattern

      find-by-alternate-id-lookup: >-
        SELECT maid.contact_id, ml.partition_number
        FROM contact_alternate_ids maid
        LEFT JOIN contact_lookup ml ON ml.contact_id = maid.contact_id
        WHERE maid.id_type = :idType AND maid.alternate_id = :alternateId

      find-by-id: >-
        SELECT m.id, m.first_name, m.last_name,
        me.email as preferred_email,
        al1.line_value as address_line_1, al2.line_value as address_line_2,
        sa.locality, sa.administrative_area, sa.postal_code, sa.country_code
        FROM contacts m
        LEFT JOIN contact_emails me ON me.contact_id = m.id AND me.preferred = true
        LEFT JOIN contact_addresses ma ON ma.contact_id = m.id AND ma.preferred = true
        LEFT JOIN addresses sa ON sa.id = ma.address_id
        LEFT JOIN address_lines al1 ON al1.address_id = sa.id AND al1.line_order = 1
        LEFT JOIN address_lines al2 ON al2.address_id = sa.id AND al2.line_order = 2
        WHERE m.id = :contactId

      fetch-alternate-ids: >-
        SELECT id_type, alternate_id FROM contact_alternate_ids WHERE contact_id = :contactId

      batch-fetch-alternate-ids: >-
        SELECT contact_id, id_type, alternate_id FROM contact_alternate_ids WHERE contact_id IN (:contactIds)

      search-by-phone: >-
        SELECT m.id, m.first_name, m.last_name,
        me.email as preferred_email,
        al1.line_value as address_line_1, al2.line_value as address_line_2,
        sa.locality, sa.administrative_area, sa.postal_code, sa.country_code
        FROM contacts m
        INNER JOIN contact_phones mp ON mp.contact_id = m.id
        LEFT JOIN contact_emails me ON me.contact_id = m.id AND me.preferred = true
        LEFT JOIN contact_addresses ma ON ma.contact_id = m.id AND ma.preferred = true
        LEFT JOIN addresses sa ON sa.id = ma.address_id
        LEFT JOIN address_lines al1 ON al1.address_id = sa.id AND al1.line_order = 1
        LEFT JOIN address_lines al2 ON al2.address_id = sa.id AND al2.line_order = 2
        WHERE mp.phone_number = :phoneNumber
        LIMIT :limit

    bulk:
      insert-contact: >-
        INSERT INTO contacts (first_name, last_name) VALUES (?, ?)

      insert-phone: >-
        INSERT INTO contact_phones (contact_id, phone_number, phone_type) VALUES (?, ?, ?)

      insert-email: >-
        INSERT INTO contact_emails (contact_id, email, email_type, preferred) VALUES (?, ?, ?, ?)

      insert-address: >-
        INSERT INTO addresses (locality, administrative_area, postal_code, country_code)
        VALUES (?, ?, ?, ?)

      insert-address-line: >-
        INSERT INTO address_lines (address_id, line_order, line_value) VALUES (?, ?, ?)

      insert-contact-address: >-
        INSERT INTO contact_addresses (contact_id, address_id, address_type, preferred) VALUES (?, ?, ?, ?)

      insert-pending-action: >-
        INSERT INTO contact_pending_actions (contact_id, action_type, created_at) VALUES (?, ?, ?)

      insert-contact-lookup: >-
        INSERT INTO contact_lookup (contact_id, partition_number, created_at) VALUES (?, ?, ?)

